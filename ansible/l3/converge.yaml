---
- name: L3 OS Convergence
  hosts: "{{ converge_group }}"
  gather_facts: true
  become: true

  tasks:
    # -----------------
    # Arch steps
    # -----------------
    - name: L3 | Arch | sanity
      ansible.builtin.include_role:
        name: arch_sanity
        apply:
          tags: [l3, os_arch, step_sanity]
      when: converge_arch
      tags: [l3, os_arch, step_sanity]

    - name: L3 | Arch | base
      ansible.builtin.include_role:
        name: arch_base
        apply:
          tags: [l3, os_arch, step_base]
      when: converge_arch
      tags: [l3, os_arch, step_base]

    - name: L3 | Arch | harden
      ansible.builtin.include_role:
        name: arch_harden
        apply:
          tags: [l3, os_arch, step_harden]
      when: converge_arch
      tags: [l3, os_arch, step_harden]

    - name: L3 | Arch | services
      ansible.builtin.include_role:
        name: arch_services
        apply:
          tags: [l3, os_arch, step_services]
      when: converge_arch
      tags: [l3, os_arch, step_services]

    - name: L3 | Arch | AUR
      ansible.builtin.include_role:
        name: arch_aur
        apply:
          tags: [l3, os_arch, step_aur]
      when: converge_arch_aur
      tags: [l3, os_arch, step_aur]

    - name: L3 | Arch | nvidia
      ansible.builtin.include_role:
        name: arch_nvidia
        apply:
          tags: [l3, os_arch, step_nvidia]
      when: converge_arch_nvidia
      tags: [l3, os_arch, step_nvidia]

    - name: L3 | Arch | desktop
      ansible.builtin.include_role:
        name: arch_desktop 
        apply:
          tags: [l3, os_arch, step_desktop]
      when: converge_arch_desktop
      tags: [l3, os_arch, step_desktop]

    - name: Reboot if required (aggregated)
      ansible.builtin.reboot:
        reboot_timeout: 600
      when: arch_reboot_required | default(false)
      become: true
      tags: [l3, os_arch, step_desktop, step_nvidia]

    - name: L3 | Arch | docker
      ansible.builtin.include_role:
        name: arch_docker
        apply:
          tags: [l3, os_arch, step_docker]
      when: converge_docker and converge_arch
      tags: [l3, os_arch, step_docker]

    # -----------------
    # Ubuntu steps
    # -----------------
    - name: L3 | Ubuntu | base
      ansible.builtin.include_role:
        name: ubuntu_base
        apply:
          tags: [l3, os_ubuntu, step_base]
      when: converge_ubuntu
      tags: [l3, os_ubuntu, step_base]

    - name: L3 | Ubuntu | harden
      ansible.builtin.include_role:
        name: ubuntu_harden
        apply:
          tags: [l3, os_ubuntu, step_harden]
      when: converge_ubuntu
      tags: [l3, os_ubuntu, step_harden]

    - name: L3 | Ubuntu | docker
      ansible.builtin.include_role:
        name: ubuntu_docker
        apply:
          tags: [l3, os_ubuntu, step_docker]
      when: converge_docker and converge_ubuntu
      tags: [l3, os_ubuntu, step_docker]

    - name: L3 | Ubuntu | openvpn
      ansible.builtin.include_role:
        name: ubuntu_openvpn
        apply:
          tags: [l3, os_ubuntu, step_openvpn]
      when: converge_openvpn and converge_ubuntu
      tags: [l3, os_ubuntu, step_openvpn]

    # -----------------
    # Steps for all OS
    # -----------------
    - name: L3 | All | users
      ansible.builtin.include_role:
        name: all_users
        apply:
          tags: [l3, step_users]
      when: converge_arch or converge_ubuntu
      tags: [l3, step_users]

    - name: L3 | All | shell
      ansible.builtin.include_role:
        name: all_shell
        apply:
          tags: [l3, step_shell]
      when: converge_arch or converge_ubuntu
      tags: [l3, step_shell]

    - name: L3 | All | ssh keys
      ansible.builtin.include_role:
        name: all_ssh_keys
        apply:
          tags: [l3, step_ssh_keys]
      when: converge_arch or converge_ubuntu
      tags: [l3, step_ssh_keys]

    - name: L3 | All | metrics wrapper
      ansible.builtin.include_role:
        name: all_metrics_wrapper
        apply:
          tags: [l3, step_metrics_wrapper]
      when: converge_arch or converge_ubuntu
      tags: [l3, step_metrics_wrapper]

    - name: L3 | All | backup runner
      ansible.builtin.include_role:
        name: all_backup_runner
        apply:
          tags: [l3, step_backup]
      when: converge_arch or converge_ubuntu
      tags: [l3, step_backup]

    - name: L3 | All | s3 mirror
      ansible.builtin.include_role:
        name: all_s3_mirror
        apply:
          tags: [l3, step_s3_mirror]
      when: converge_s3_mirror
      tags: [l3, step_s3_mirror]

    - name: L3 | All | postgres dump
      ansible.builtin.include_role:
        name: all_postgres_dump
        apply:
          tags: [l3, step_db_dump]
      when: converge_postgres_dump
      tags: [l3, step_db_dump]

    - name: L3 | All | node exporter
      ansible.builtin.include_role:
        name: all_node_exporter
        apply:
          tags: [l3, step_node_exporter]
      when: converge_node_exporter
      tags: [l3, step_node_exporter]

    - name: L3 | All | devops
      ansible.builtin.include_role:
        name: all_devops
        apply:
          tags: [l3, step_devops]
      when: converge_devops
      tags: [l3, step_devops]

    - name: L3 | All | docker monitoring
      ansible.builtin.include_role:
        name: all_docker_monitoring
      when: converge_docker_monitoring
      tags: [l3, step_docker_monitoring]

    - name: L3 | All | tailscale client
      ansible.builtin.include_role:
        name: all_tailscale
      when: converge_tailscale
      tags: [l3, step_tailscale]
