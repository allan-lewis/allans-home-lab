---
- name: L3 OS Convergence
  hosts: "{{ converge_group }}"
  gather_facts: true
  become: true

  vars:
    in_arch: "{{ inventory_hostname in (groups['arch'] | default([])) }}"
    in_arch_aur: "{{ inventory_hostname in (groups['arch_aur'] | default([])) }}"
    in_arch_desktop: "{{ inventory_hostname in (groups['arch_desktop'] | default([])) }}"
    in_arch_node_exporter: "{{ inventory_hostname in (groups['arch_node_exporter'] | default([])) }}"
    in_ubuntu: "{{ inventory_hostname in (groups['ubuntu'] | default([])) }}"
    in_ubuntu_node_exporter: "{{ inventory_hostname in (groups['ubuntu_node_exporter'] | default([])) }}"

  tasks:
    # -----------------
    # Arch steps
    # -----------------
    - name: L3 | Arch | base
      ansible.builtin.include_role:
        name: arch_base
        apply:
          tags: [l3, os_arch, step_base]
      when: in_arch
      tags: [l3, os_arch, step_base]

    - name: L3 | Arch | harden
      ansible.builtin.include_role:
        name: arch_harden
        apply:
          tags: [l3, os_arch, step_harden]
      when: in_arch
      tags: [l3, os_arch, step_harden]

    - name: L3 | Arch | services
      ansible.builtin.include_role:
        name: arch_services
        apply:
          tags: [l3, os_arch, step_services]
      when: in_arch
      tags: [l3, os_arch, step_services]

    - name: L3 | Arch | AUR
      ansible.builtin.include_role:
        name: arch_aur
        apply:
          tags: [l3, os_arch, step_aur]
      when: in_arch_aur
      tags: [l3, os_arch, step_aur]

    - name: L3 | Arch | desktop
      ansible.builtin.include_role:
        name: arch_desktop
        apply:
          tags: [l3, os_arch, step_desktop]
      when: in_arch_desktop
      tags: [l3, os_arch, step_desktop]

    # -----------------
    # Ubuntu steps
    # -----------------
    # - name: L3 | Ubuntu | base
    #   ansible.builtin.include_role:
    #     name: ubuntu_base
    #     apply:
    #       tags: [l3, os_ubuntu, step_base]
    #   when: in_ubuntu
    #   tags: [l3, os_ubuntu, step_base]

    # - name: L3 | Ubuntu | harden
    #   ansible.builtin.include_role:
    #     name: ubuntu_harden
    #     apply:
    #       tags: [l3, os_ubuntu, step_harden]
    #   when: in_ubuntu
    #   tags: [l3, os_ubuntu, step_harden]

    # -----------------
    # Steps for all OS
    # -----------------
    - name: L3 | All | shell
      ansible.builtin.include_role:
        name: all_shell
        apply:
          tags: [l3, step_shell]
      when: in_arch or in_ubuntu
      tags: [l3, step_shell]

    - name: L3 | All | node exporter
      ansible.builtin.include_role:
        name: all_node_exporter
        apply:
          tags: [l3, step_node_exporter]
      when: in_arch_node_exporter or in_ubuntu_node_exporter
      tags: [l3, step_node_exporter]
