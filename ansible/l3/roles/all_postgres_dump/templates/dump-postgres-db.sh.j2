#!/usr/bin/env bash
set -euo pipefail

ts() { date '+%F %T'; }
log(){ echo "$(ts) | $*"; }

BACKUP_DIR="{{ postgres_db_backup_dir }}"
KEEP_DAYS="{{ postgres_db_backup_keep_days }}"

# Load runtime configuration (written by L4)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="${SCRIPT_DIR}/dump-postgres-db.env"

if [[ ! -f "$ENV_FILE" ]]; then
  log "No env file found ($ENV_FILE); nothing to do."
  exit 0
fi

# shellcheck disable=SC1090
source "$ENV_FILE"

timestamp=$(date +"%Y%m%d-%H%M%S")
outfile="$BACKUP_DIR/${DB}-${timestamp}.dump"

mkdir -p "$BACKUP_DIR"

log "Starting Postgres dump…"

if [[ -n "$CONTAINER" ]]; then
  # ---- Docker mode ----
  log "Mode: docker exec → $CONTAINER (db=$DB user=$USER)"
  export PGPASSWORD="$PASS"
  # shellcheck disable=SC2086
  docker exec -e PGPASSWORD="$PASS" "$CONTAINER" \
    pg_dump -U "$USER" -d "$DB" -Fc ${EXTRA_ARGS} > "$outfile"

elif [[ -n "$KNS" ]]; then
  # ---- Kubernetes mode ----
  if [[ -z "$KPOD" && -n "$KSEL" ]]; then
    KPOD="$(kubectl -n "$KNS" get pods -l "$KSEL" -o jsonpath='{.items[?(@.status.phase=="Running")].metadata.name}' | awk '{print $1}')"
  fi
  if [[ -z "$KPOD" ]]; then
    log "ERROR: No pod resolved. Set postgres_db_k8s_pod or a working postgres_db_k8s_selector."
    exit 1
  fi
  log "Mode: kubectl exec → ${KNS}/${KPOD}${KCTR:+ (container=$KCTR)} (db=$DB user=$USER)"
  export PGPASSWORD="$PASS"
  # shellcheck disable=SC2086
  kubectl -n "$KNS" exec "$KPOD" ${KCTR:+-c "$KCTR"} -- \
    env PGPASSWORD="$PASS" pg_dump -U "$USER" -d "$DB" -Fc ${EXTRA_ARGS} > "$outfile"

else
  log "ERROR: No mode configured (set postgres_db_container OR postgres_db_k8s_namespace)."
  exit 1
fi

log "Dump complete: $outfile"
find "$BACKUP_DIR" -type f -name "${DB}-*.dump" -mtime +$KEEP_DAYS -print -delete || true
log "Prune complete (keep $KEEP_DAYS days)"
