---
- name: "Lookup home directory for {{ dot_user }}"
  ansible.builtin.getent:
    database: passwd
    key: "{{ dot_user }}"

- name: "Set dotfiles_home fact for {{ dot_user }}"
  ansible.builtin.set_fact:
    # passwd format: name:pass:uid:gid:gecos:home:shell  -> home is index 4 in getent_passwd list
    dotfiles_home: "{{ getent_passwd[dot_user][4] }}"

- name: "Ensure login shell for {{ dot_user }} is zsh"
  become: true
  ansible.builtin.user:
    name: "{{ dot_user }}"
    shell: "{{ dotfiles_shell }}"

- name: "Ensure dotfiles destination directory exists for {{ dot_user }}"
  become: true
  become_user: "{{ dot_user }}"
  ansible.builtin.file:
    path: "{{ dotfiles_dest }}"
    state: directory
    mode: "0755"

- name: "Clone or update dotfiles repo (HTTPS) for {{ dot_user }}"
  become: true
  become_user: "{{ dot_user }}"
  ansible.builtin.git:
    repo: "{{ dotfiles_repo }}"
    dest: "{{ dotfiles_dest }}"
    version: "{{ dotfiles_version }}"
    update: true
    force: true

- name: "Ensure plugins directory exists under ZDOTDIR for {{ dot_user }}"
  become: true
  become_user: "{{ dot_user }}"
  ansible.builtin.file:
    path: "{{ dotfiles_home }}/.config/zsh/plugins"
    state: directory
    mode: "0755"

- name: "Clone/update zsh plugins for {{ dot_user }}"
  become: true
  become_user: "{{ dot_user }}"
  ansible.builtin.git:
    repo: "{{ item.repo }}"
    dest: "{{ dotfiles_home }}/.config/zsh/plugins/{{ item.name }}"
    version: "{{ item.version | default('HEAD') }}"
    update: true
    force: true
  loop: "{{ dotfiles_zsh_plugins }}"

- name: "Apply stow packages for {{ dot_user }}"
  become: true
  become_user: "{{ dot_user }}"
  ansible.builtin.command:
    cmd: "stow --restow {{ item }}"
    chdir: "{{ dotfiles_dest }}"
  loop: "{{ dotfiles_stow_packages }}"
  changed_when: false
