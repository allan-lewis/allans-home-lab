---
# NVIDIA GPU setup for Plasma/X11

- name: GPU | NVIDIA | Install driver packages
  community.general.pacman:
    name:
      - nvidia-open
      - nvidia-utils
      - nvidia-settings
      - opencl-nvidia
    state: present
  become: true
  tags: ['arch_desktop', 'gpu', 'nvidia']

- name: GPU | NVIDIA | Blacklist nouveau
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-nouveau.conf
    content: |
      blacklist nouveau
      options nouveau modeset=0
    owner: root
    group: root
    mode: '0644'
  become: true
  tags: ['arch_desktop', 'gpu', 'nvidia']

- name: GPU | NVIDIA | Force NVIDIA as primary Xorg GPU
  ansible.builtin.copy:
    dest: /etc/X11/xorg.conf.d/10-nvidia-primary.conf
    content: |
      Section "Device"
          Identifier  "Nvidia Card"
          Driver      "nvidia"
          BusID       "PCI:1:0:0"
          Option      "AllowEmptyInitialConfiguration"
          Option      "PrimaryGPU" "yes"
      EndSection
    owner: root
    group: root
    mode: '0644'
  become: true
  tags: ['arch_desktop', 'gpu', 'nvidia']

- name: GPU | NVIDIA | Rebuild initramfs
  ansible.builtin.command: mkinitcpio -P
  become: true
  changed_when: false
  tags: ['arch_desktop', 'gpu', 'nvidia']
