---
# XFCE-only desktop convergence for Arch Linux (no reboot inside role)

- name: Desktop | Reboot flag defaults
  ansible.builtin.set_fact:
    arch_reboot_required: "{{ arch_reboot_required | default(false) }}"
    arch_reboot_reasons: "{{ arch_reboot_reasons | default([]) }}"
  tags: ['arch_desktop']

# Strongly recommended on Arch: avoid partial-upgrade conflicts during big installs
- name: Desktop | Full system upgrade (avoid partial upgrade conflicts)
  community.general.pacman:
    update_cache: true
    upgrade: true
  become: true
  tags: ['arch_desktop']

# Base services everyone needs on a desktop
- name: Desktop | Ensure core packages (NetworkManager, PipeWire stack)
  community.general.pacman:
    name:
      - networkmanager
      - pipewire
      - pipewire-alsa
      - pipewire-pulse
      - wireplumber
    state: present
  become: true
  tags: ['arch_desktop']

# XFCE + LightDM packages
- name: Desktop | Install XFCE packages
  community.general.pacman:
    name:
      - xfce4
      - xfce4-goodies
      - network-manager-applet
    state: present
  become: true
  tags: ['arch_desktop']

- name: Desktop | Install LightDM packages
  community.general.pacman:
    name:
      - lightdm
      - lightdm-gtk-greeter
    state: present
  become: true
  tags: ['arch_desktop']

# Enable the right services
- name: Desktop | Enable NetworkManager
  ansible.builtin.systemd:
    name: NetworkManager
    enabled: true
    state: started
  become: true
  tags: ['arch_desktop']

# Safety: ensure other DMs don't "win" if installed
- name: Desktop | Disable other known display managers (safety)
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: false
    state: stopped
  loop:
    - sddm
    - gdm
  become: true
  failed_when: false
  tags: ['arch_desktop']

- name: Desktop | Enable LightDM
  ansible.builtin.systemd:
    name: lightdm
    enabled: true
    state: started
  become: true
  tags: ['arch_desktop']

# Optional features: Bluetooth
- name: Desktop | Bluetooth packages (optional)
  community.general.pacman:
    name: [ 'bluez', 'bluez-utils', 'blueman' ]
    state: present
  become: true
  when: arch_desktop_enable_bluetooth
  tags: ['arch_desktop']

- name: Desktop | Enable bluetooth (optional)
  ansible.builtin.systemd:
    name: bluetooth
    enabled: true
    state: started
  become: true
  when: arch_desktop_enable_bluetooth
  tags: ['arch_desktop']

# Optional features: Printing
- name: Desktop | Printing packages (optional)
  community.general.pacman:
    name: [ 'cups', 'system-config-printer' ]
    state: present
  become: true
  when: arch_desktop_enable_printing
  tags: ['arch_desktop']

- name: Desktop | Enable CUPS (optional)
  ansible.builtin.systemd:
    name: cups
    enabled: true
    state: started
  become: true
  when: arch_desktop_enable_printing
  tags: ['arch_desktop']

# Fonts & extra apps
- name: Desktop | Fonts
  community.general.pacman:
    name: "{{ arch_desktop_extra_fonts }}"
    state: present
  become: true
  when: arch_desktop_extra_fonts | length > 0
  tags: ['arch_desktop']

- name: Desktop | Extra packages
  community.general.pacman:
    name: "{{ arch_desktop_extra_packages }}"
    state: present
  become: true
  when: arch_desktop_extra_packages | length > 0
  tags: ['arch_desktop']

- name: Flatpak | Install requested Flatpak apps (if any)
  ansible.builtin.command: >
    flatpak install -y flathub {{ item }}
  loop: "{{ arch_desktop_flatpak_apps | default([]) }}"
  when: (arch_desktop_flatpak_apps | default([])) | length > 0
  become: true