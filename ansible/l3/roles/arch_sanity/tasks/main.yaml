---
- name: Kernel sanity | Capture running kernel version
  ansible.builtin.command: uname -r
  register: _kernel_version
  changed_when: false

- name: Kernel sanity | Check matching modules directory exists
  ansible.builtin.stat:
    path: "/usr/lib/modules/{{ _kernel_version.stdout }}"
  register: _kernel_modules_dir

- name: Kernel sanity | Fail if running kernel has no matching modules
  ansible.builtin.fail:
    msg: >-
      Kernel/modules mismatch detected.
      Running kernel: {{ _kernel_version.stdout }}
      Missing: /usr/lib/modules/{{ _kernel_version.stdout }}
      This host must be rebooted or rebuilt before continuing.
  when: not _kernel_modules_dir.stat.exists

- name: Kernel sanity | Read booted kernel path
  ansible.builtin.command: cat /proc/cmdline
  register: _cmdline
  changed_when: false

- name: Kernel sanity | Fail if not booting /boot/vmlinuz-linux
  ansible.builtin.fail:
    msg: >-
      Unexpected boot image.
      /proc/cmdline={{ _cmdline.stdout }}
      Expected BOOT_IMAGE=/boot/vmlinuz-linux
  when: "'BOOT_IMAGE=/boot/vmlinuz-linux' not in _cmdline.stdout"

- name: Pacman sanity | Dry-run pacman DB lock check
  ansible.builtin.command: pacman -Sy --noconfirm --needed filesystem
  changed_when: false

- name: Pacman | wait for database lock to be released
  ansible.builtin.wait_for:
    path: /var/lib/pacman/db.lck
    state: absent
    timeout: 120 
  become: true
