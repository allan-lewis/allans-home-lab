{
  description = "Allan's Homelab - NixOS L3 converge (baseline + packages) for {{ inventory_hostname }}";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.11";

    # Home Manager (NixOS module)
    home-manager.url = "github:nix-community/home-manager/release-25.11";
    home-manager.inputs.nixpkgs.follows = "nixpkgs";
  };

  outputs = { self, nixpkgs, home-manager }:
  let
    system = "x86_64-linux";
  in
  {
    nixosConfigurations.{{ inventory_hostname }} = nixpkgs.lib.nixosSystem {
      inherit system;

      modules = [
        # Enable Home Manager on NixOS
        home-manager.nixosModules.home-manager

        # Pull in the host's disk + bootloader + hardware settings.
        # Without this, NixOS asserts that '/' and bootloader aren't configured.
        /etc/nixos/hardware-configuration.nix

        ({ pkgs, ... }:
          {
            boot.loader.grub.enable = true;
            boot.loader.grub.device = "/dev/sda";

            # ---- Identity ----
            networking.hostName = "{{ inventory_hostname }}";

            # ---- Keep remote access working ----
            services.openssh.enable = true;

            services.openssh.settings = {
              PermitRootLogin = "no";
              PasswordAuthentication = false;
              KbdInteractiveAuthentication = false;
            };

            services.openssh.extraConfig = ''
              AllowUsers lab
            '';

            # Keep Proxmox integration + cloud-init (so you don't regress networking/keys behavior)
            services.qemuGuest.enable = true;
            services.cloud-init.enable = true;
            services.cloud-init.network.enable = true;

            networking.useNetworkd = true;
            networking.useDHCP = false;

            virtualisation.docker.enable = {{ (converge_docker | default(false) | bool) | string | lower }};

            programs.zsh.enable = true;

            # ---- Automation-friendly sudo (so Ansible can keep driving) ----
            users.users.lab = {
              isNormalUser = true;
              extraGroups = [ "wheel" "docker" ];
              shell = pkgs.zsh;
              # lock password (SSH keys still work)
              hashedPassword = "!";
            };

            security.sudo.enable = true;
            security.sudo.wheelNeedsPassword = false;

            time.timeZone = "UTC";

            # ---- Nix features ----
            nix.settings.experimental-features = [ "nix-command" "flakes" ];

            # ---- Home Manager ----
            home-manager.useGlobalPkgs = true;
            home-manager.useUserPackages = true;

            home-manager.users.lab = { pkgs, ... }: {
              home.stateVersion = "25.11";

              # Starship via HM; config sourced from your dotfiles clone
              programs.starship.enable = true;
              xdg.configFile."starship.toml".source = /home/lab/.dotfiles/common-starship/.config/starship.toml;

              # Zsh plugins managed by HM (no stow / no plugin git clones needed)
              programs.zsh = {
                enable = true;
                enableCompletion = true;

                plugins = [
                  { name = "zsh-autosuggestions"; src = pkgs.zsh-autosuggestions; }
                  { name = "zsh-syntax-highlighting"; src = pkgs.zsh-syntax-highlighting; }
                  { name = "zsh-history-substring-search"; src = pkgs.zsh-history-substring-search; }
                ];

                # Optional: if your dotfiles repo has a zsh entrypoint you want to source,
                # set it here (adjust path to match your repo layout).
                # initExtra = ''
                #   source "$HOME/.dotfiles/zsh/.zshrc"
                # '';
              };

              # User-scoped packages (anything that is "home environment" oriented)
              home.packages = with pkgs; [
                starship
                zsh-autosuggestions
                zsh-syntax-highlighting
                zsh-history-substring-search
              ];
            };

            # ---- Packages ----
            environment.systemPackages = with pkgs; [
              btop
              cmatrix
              curl
{% if converge_docker | default(false) %}
              docker-compose
{% endif %}
              fastfetch
              git
              neovim
              nfs-utils
              python3
              unzip
            ];

            # Required (donâ€™t change lightly)
            system.stateVersion = "25.11";
          }
        )
      ];
    };
  };
}

