{
  description = "Allan's Homelab - NixOS L3 converge (baseline + packages) for {{ inventory_hostname }}";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.11";

    # Home Manager (NixOS module)
    home-manager.url = "github:nix-community/home-manager/release-25.11";
    home-manager.inputs.nixpkgs.follows = "nixpkgs";
  };

  outputs = { self, nixpkgs, home-manager }:
  let
    system = "x86_64-linux";
  in
  {
    nixosConfigurations.{{ inventory_hostname }} = nixpkgs.lib.nixosSystem {
      inherit system;

      modules = [
        # Enable Home Manager on NixOS
        home-manager.nixosModules.home-manager

        # Pull in the host's disk + bootloader + hardware settings.
        # Without this, NixOS asserts that '/' and bootloader aren't configured.
        /etc/nixos/hardware-configuration.nix

        ({ pkgs, ... }:
          {
            boot.loader.grub.enable = true;
            boot.loader.grub.device = "/dev/sda";

            # ---- Identity ----
            networking.hostName = "{{ inventory_hostname }}";

            # ---- Keep remote access working ----
            services.openssh.enable = true;

            services.openssh.settings = {
              PermitRootLogin = "no";
              PasswordAuthentication = false;
              KbdInteractiveAuthentication = false;
            };

            services.openssh.extraConfig = ''
              AllowUsers lab
            '';

            # Keep Proxmox integration + cloud-init (so you don't regress networking/keys behavior)
            services.qemuGuest.enable = true;
            services.cloud-init.enable = true;
            services.cloud-init.network.enable = true;

            networking.useNetworkd = true;
            networking.useDHCP = false;

            virtualisation.docker.enable = {{ (converge_docker | default(false) | bool) | string | lower }};

            programs.zsh.enable = true;

            # ---- Automation-friendly sudo (so Ansible can keep driving) ----
            users.users.lab = {
              isNormalUser = true;
              extraGroups = [ "wheel" "docker" ];
              shell = pkgs.zsh;
              # lock password (SSH keys still work)
              hashedPassword = "!";
            };

            security.sudo.enable = true;
            security.sudo.wheelNeedsPassword = false;

            time.timeZone = "UTC";

            # ---- Nix features ----
            nix.settings.experimental-features = [ "nix-command" "flakes" ];

            # ---- Home Manager ----
            home-manager.useGlobalPkgs = true;
            home-manager.useUserPackages = true;

            home-manager.users.lab = { pkgs, ... }: {
              home.stateVersion = "25.11";

              # --- Dotfiles wiring (XDG zsh + starship) ---
              # ZDOTDIR is set by your .zshenv to ~/.config/zsh
              home.file.".zshenv".source =
                /home/lab/.dotfiles/common-zsh/.zshenv;

              xdg.configFile."zsh/.zshrc".source =
                /home/lab/.dotfiles/common-zsh/.config/zsh/.zshrc;

              xdg.configFile."zsh/common.zsh".source =
                /home/lab/.dotfiles/common-zsh/.config/zsh/common.zsh;

              xdg.configFile."zsh/login-fastfetch.zsh".source =
                /home/lab/.dotfiles/common-zsh/.config/zsh/login-fastfetch.zsh;

              # Starship config lives in your repo at common-starship/.config/starship.toml
              programs.starship.enable = true;
              xdg.configFile."starship.toml".source =
                /home/lab/.dotfiles/common-starship/.config/starship.toml;

              # Match your common.zsh expectations exactly:
              xdg.configFile."zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh".source =
                "${pkgs.zsh-autosuggestions}/share/zsh-autosuggestions/zsh-autosuggestions.zsh";

              xdg.configFile."zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh".source =
                "${pkgs.zsh-syntax-highlighting}/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh";


              # If you later add more plugins to common.zsh, add more mappings like above.

              # User-scoped packages used by your dotfiles (starship prompt, login fastfetch, etc.)
              home.packages = with pkgs; [
                starship
                fastfetch
              ];
            };

            # NFS mounts generated from Ansible inventory
            fileSystems = {
            {% for item in (all_nfs_mounts | default([])) if item.nfs_server and item.nfs_path %}
              "{{ item.path }}" = {
                device = "{{ item.nfs_server }}:{{ item.nfs_path }}";
                fsType = "nfs";
                options = [
                  "{{ item.nfs_opts | default('ro') }}"
                  "nofail"
                  "_netdev"
                  "x-systemd.requires=network-online.target"
                  "x-systemd.after=network-online.target"
                ];
              };
            {% endfor %}
            };

            systemd.tmpfiles.rules = [
{% if converge_docker | default(false) %}
              "d /opt/docker-compose 0750 root root -"
{% endif %}
              "d /var/lib/node_exporter/textfile_collector 0755 root root -"
            ];

            # ---- Packages ----
            environment.systemPackages = with pkgs; [
              btop
              cmatrix
              curl
{% if converge_docker | default(false) %}
              docker-compose
{% endif %}
              git
              neovim
              nfs-utils
              python3
              unzip
            ];

            # Required (donâ€™t change lightly)
            system.stateVersion = "25.11";
          }
        )
      ];
    };
  };
}

