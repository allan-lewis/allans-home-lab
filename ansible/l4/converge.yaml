---
- name: L4 OS Convergence
  hosts: "{{ converge_group }}"
  gather_facts: true
  become: true

  tasks:
    # -----------------
    # Ubuntu steps
    # -----------------
    - name: L4 | Ubuntu | openvpn
      ansible.builtin.include_role:
        name: ubuntu_openvpn
        apply:
          tags: [l4, os_ubuntu, step_openvpn]
      when: converge_openvpn and converge_ubuntu
      tags: [l4, os_ubuntu, step_openvpn]

    # -----------------
    # Steps for all OS
    # -----------------
    - name: L4 | All | restore
      ansible.builtin.include_role:
        name: all_restore
        apply:
          tags: [l4, step_restore]
      when: converge_restore
      tags: [l4, step_restore]
    
    - name: L4 | All | backups
      ansible.builtin.include_role:
        name: all_backups
        apply:
          tags: [l4, step_backups]
      when: converge_ubuntu or converge_arch
      tags: [l4, step_backups]

    - name: L4 | All | devops
      ansible.builtin.include_role:
        name: all_devops
        apply:
          tags: [l4, step_devops]
      when: converge_devops
      tags: [l4, step_devops]

    - name: L4 | All | s3 mirror
      ansible.builtin.include_role:
        name: all_s3_mirror
        apply:
          tags: [l4, step_s3_mirror]
      when: converge_s3_mirror
      tags: [l4, step_s3_mirror]

    - name: L4 | All | postgres dump
      ansible.builtin.include_role:
        name: all_postgres_dump
        apply:
          tags: [l4, step_db_dump]
      when: converge_postgres_dump
      tags: [l4, step_db_dump]

    - name: L4 | All | docker gatus
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_gatus]
      when: converge_docker_gatus
      tags: [l4, step_docker_gatus]
      vars:
        compose_app_name: gatus
        compose_source_type: template
        compose_template_src: "templates/docker-compose/gatus.compose.yaml.j2"
        compose_extra_templates:
          - src: "templates/gatus/gatus.config.yaml.j2"
            dest: "{{ gatus_config_dir }}/config.yaml"
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
        compose_paths:
          - path: "{{ gatus_data_dir }}" # /var/lib/gatus
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ gatus_config_dir }}" # /etc/gatus
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"

    - name: L4 | All | docker it tools
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_it_tools]
      when: converge_docker_it_tools
      tags: [l4, step_docker_it_tools]
      vars:
        compose_app_name: tools
        compose_source_type: file
        compose_file_src: files/docker-compose/it-tools.compose.yaml

    - name: L4 | All | docker no geeks brewing
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_ngb]
      when: converge_docker_ngb
      tags: [l4, step_docker_ngb]
      vars:
        compose_app_name: no_geeks_brewing
        compose_source_type: file
        compose_file_src: files/docker-compose/no_geeks_brewing.compose.yaml
        compose_env:
          NO_GEEKS_BREWING_AUTHENTIK_CLIENT_ID:  "{{ lookup('env', 'NO_GEEKS_BREWING_AUTHENTIK_CLIENT_ID') }}"
          NO_GEEKS_BREWING_AUTHENTIK_CLIENT_SECRET: "{{ lookup('env', 'NO_GEEKS_BREWING_AUTHENTIK_CLIENT_SECRET') }}"
          NO_GEEKS_BREWING_AUTHENTIK_ISSUER_URL: "{{ lookup('env', 'NO_GEEKS_BREWING_AUTHENTIK_ISSUER_URL') }}"
          NO_GEEKS_BREWING_BREWFATHER_AUTH_TOKEN: "{{ lookup('env', 'NO_GEEKS_BREWING_BREWFATHER_AUTH_TOKEN') }}"
          NO_GEEKS_BREWING_POST_LOGOUT_REDIRECT_URI: "{{ lookup('env', 'NO_GEEKS_BREWING_POST_LOGOUT_REDIRECT_URI') }}"
          NO_GEEKS_BREWING_AUTHENTIK_LOGOUT_URI: "{{ lookup('env', 'NO_GEEKS_BREWING_AUTHENTIK_LOGOUT_URI') }}"
          NO_GEEKS_BREWING_REDIRECT_URI: "{{ lookup('env', 'NO_GEEKS_BREWING_REDIRECT_URI') }}"

    - name: L4 | All | docker memos
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_memos]
      when: converge_docker_memos
      tags: [l4, step_docker_memos]
      vars:
        compose_app_name: memos
        compose_source_type: template
        compose_template_src: "templates/docker-compose/memos.compose.yaml.j2"
        compose_paths:
          - path: "{{ memos_data_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"

    - name: L4 | All | docker portainer
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_portainer]
      when: converge_docker_portainer
      tags: [l4, step_docker_portainer]
      vars:
        compose_app_name: portainer
        compose_source_type: template
        compose_template_src: "templates/docker-compose/portainer.compose.yaml.j2"
        compose_paths:
          - path: "{{ portainer_data_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"

    - name: L4 | All | docker nginx
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_nginx]
      when: converge_docker_nginx
      tags: [l4, step_docker_nginx]
      vars:
        compose_app_name: nginx
        compose_source_type: file
        compose_file_src: files/docker-compose/nginx.compose.yaml

    - name: L4 | All | docker vaultwarden
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_vaultwarden]
      when: converge_docker_vaultwarden
      tags: [l4, step_docker_vaultwarden]
      vars:
        compose_app_name: vaultwarden
        compose_source_type: template
        compose_template_src: templates/docker-compose/vaultwarden.compose.yaml.j2
        compose_env: 
          ADMIN_TOKEN:  "{{ lookup('env', 'VAULTWARDEN_ADMIN_TOKEN') }}"
          SIGNUPS_ALLOWED: "false"
        compose_paths:
          - path: "/var/lib/vaultwarden"
            create: true
            mode: "0755"

    - name: L4 | All | docker tautulli
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_tautulli]
      when: converge_docker_tautulli
      tags: [l4, step_docker_tautulli]
      vars:  
        compose_app_name: tautulli
        compose_source_type: template
        compose_template_src: templates/docker-compose/tautulli.compose.yaml.j2
        compose_paths:
          - path: "{{ tautulli_config_dir}}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"

    - name: L4 | All | docker authentik
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_authentik]
      when: converge_docker_authentik
      tags: [l4, step_docker_authentik]
      vars:
        compose_app_name: authentik
        compose_source_type: url
        compose_url: "https://docs.goauthentik.io/docker-compose.yml"
        compose_env:
          AUTHENTIK_TAG: "2025.10.3"
          COMPOSE_PORT_HTTP: 9180
          COMPOSE_PORT_HTTPS: 9143
          PG_PASS: "{{ lookup('env', 'DOCKER_AUTHENTIK_PG_PASS') }}"
          AUTHENTIK_SECRET_KEY: "{{ lookup('env', 'DOCKER_AUTHENTIK_SECRET_KEY') }}"

    - name: L4 | All | docker traefik
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_traefik]
      when: converge_docker_traefik
      tags: [l4, step_docker_traefik]
      vars:
        compose_app_name: traefik
        compose_source_type: template
        compose_template_src: "templates/docker-compose/traefik.compose.yaml.j2"
        compose_env:
          CLOUDFLARE_EMAIL: "allan.e.lewis@gmail.com"
          CLOUDFLARE_API_KEY: "{{ lookup('env', 'TRAEFIK_CF_API_KEY') }}"
        compose_extra_templates:
          - src: "templates/traefik/traefik.config.yaml.j2"
            dest: "{{ traefik_config_dir }}/traefik.yaml"
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
        compose_paths:
          - path: "{{ traefik_acme_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ traefik_config_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"

    # - name: L4 | All | docker pihole
    #   ansible.builtin.include_role:
    #     name: all_docker_compose
    #     apply:
    #       tags: [l4, step_docker_pihole]
    #   when: converge_docker_pihole
    #   tags: [l4, step_docker_pihole]

    - name: L4 | All | docker plex
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_plex]
      when: converge_docker_plex
      tags: [l4, step_docker_plex]
      vars:  
        compose_app_name: plex
        compose_source_type: template
        compose_template_src: templates/docker-compose/plex.compose.yaml.j2
        compose_env:
          PLEX_TZ: "{{ gitops_tz }}"
          PLEX_PUID: "{{ gitops_uid }}"
          PLEX_PGID: "{{ gitops_gid }}"
        compose_paths:
          - path: "{{ plex_config_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ plex_transcode_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ plex_media_library }}"
            nfs: true
            nfs_server: "{{ hostvars['procyon'].ansible_host }}"
            nfs_path: "/mnt/pool1/media-library"
            nfs_opts: "ro"

    - name: L4 | All | docker jellyfin
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_jellyfin]
      when: converge_docker_jellyfin
      tags: [l4, step_docker_jellyfin]
      vars:   
        compose_app_name: jellyfin
        compose_source_type: template
        compose_template_src: templates/docker-compose/jellyfin.compose.yaml.j2
        compose_env:
          JELLYFIN_PUBLISHED_URL: "https://jellyfin.media.allanshomelab.com"
          JELLYFIN_USER_UID: "{{ gitops_uid }}"
          JELLYFIN_GROUP_GID: "{{ gitops_gid }}"
        compose_paths:
          - path: "{{ jellyfin_config_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ jellyfin_cache_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ jellyfin_media_library }}"
            nfs: true
            nfs_server: "{{ hostvars['procyon'].ansible_host }}"
            nfs_path: "/mnt/pool1/media-library"
            nfs_opts: "ro"

    - name: L4 | All | docker immich
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_immich]
      when: converge_docker_immich
      tags: [l4, step_docker_immich]
      vars:
        compose_app_name: immich
        compose_immich_version: "v2.4.1"
        # Use the vendor compose from the exact release tag
        compose_source_type: url
        compose_url: "https://github.com/immich-app/immich/releases/download/{{ compose_immich_version }}/docker-compose.yml"
        # Everything here is auto-validated (undefined/empty => fail early)
        compose_env:
          IMMICH_VERSION: "{{ compose_immich_version }}"
          UPLOAD_LOCATION: "{{ immich_upload_mount }}"
          DB_DATA_LOCATION: "{{ immich_postgres_dir }}"  
          REDIS_DATA_LOCATION: "{{ immich_redis_dir }}"
          MODEL_CACHE_LOCATION: "{{ immich_model_dir }}"
          COMPOSE_PROJECT_NAME: "immich"
          DB_USERNAME: "postgres"
          DB_DATABASE_NAME: "immich"
          DB_PASSWORD: "{{ lookup('env', 'IMMICH_DB_PASSWORD') }}"
        compose_paths:
          # NFS uploads (do not chown from client; role will verify it's NFS-mounted)
          - path: "{{ immich_upload_mount }}"
            nfs: true
            nfs_server: "{{ hostvars['procyon'].ansible_host }}"
            nfs_path: "/mnt/pool1/immich"
            nfs_opts: "rw"
          # Postgres data (local; container will chown on first init)
          - path: "{{ immich_postgres_dir }}"
            create: true
            mode: "0755"
          # Redis data (local; volatile)
          - path: "{{ immich_redis_dir }}"
            create: true
            mode: "0755"
          # Model cache (local; volatile) â€” leave root-owned
          - path: "{{ immich_model_dir }}"
            create: true
            mode: "0755"

    - name: L4 | All | docker media acquisition
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_media_acquisition]
      when: converge_docker_media_acquisition
      tags: [l4, step_docker_media_acquisition]
      vars:
        compose_app_name: media_acquisition
        compose_source_type: template
        compose_template_src: templates/docker-compose/media_acquisition.compose.yaml.j2
        compose_paths:
          - path: "{{ lidarr_config_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ radarr_config_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ sonarr_config_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ transmission_config_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ prowlarr_config_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ transmission_watch_dir }}"
            create: true
            uid: "{{ gitops_uid }}"
            gid: "{{ gitops_gid }}"
            mode: "0755"
          - path: "{{ media_acquisition_mount }}"
            nfs: true
            nfs_server: "{{ media_acquisition_nfs_server }}"
            nfs_path: "/mnt/pool1/media-acquisition"
            nfs_opts: "rw"

    - name: L4 | All | docker twingate
      ansible.builtin.include_role:
        name: all_docker_compose
        apply:
          tags: [l4, step_docker_twingate]
      when: converge_docker_twingate
      tags: [l4, step_docker_twingate]
      vars:
        compose_app_name: twingate
        compose_source_type: template
        compose_template_src: "templates/docker-compose/twingate.compose.yaml.j2"
        compose_env:
          TWINGATE_NETWORK_NAME: "{{ lookup('env', 'TWINGATE_NETWORK_NAME') }}"
          TWINGATE_ACCESS_TOKEN: "{{ twingate_access_token }}"
          TWINGATE_REFRESH_TOKEN: "{{ twingate_refresh_token }}"
