---
- name: L4 OS Convergence
  hosts: "{{ converge_group }}"
  gather_facts: true
  become: true

  tasks:
    # -----------------
    # Ubuntu steps
    # -----------------
    - name: L4 | Ubuntu | openvpn
      ansible.builtin.include_role:
        name: ubuntu_openvpn
        apply:
          tags: [l4, os_ubuntu, step_openvpn]
      when: converge_openvpn and converge_ubuntu
      tags: [l4, os_ubuntu, step_openvpn]

    # -----------------
    # Steps for all OS
    # -----------------
    - name: L4 | All | restore
      ansible.builtin.include_role:
        name: all_restore
        apply:
          tags: [l4, step_restore]
      when: converge_restore
      tags: [l4, step_restore]
    
    - name: L4 | All | backups
      ansible.builtin.include_role:
        name: all_backups
        apply:
          tags: [l4, step_backup]
      when: converge_ubuntu or converge_arch
      tags: [l4, step_backups]

    - name: L4 | All | devops
      ansible.builtin.include_role:
        name: all_devops
        apply:
          tags: [l4, step_devops]
      when: converge_devops
      tags: [l4, step_devops]

    - name: L4 | All | s3 mirror
      ansible.builtin.include_role:
        name: all_s3_mirror
        apply:
          tags: [l4, step_s3_mirror]
      when: converge_s3_mirror
      tags: [l4, step_s3_mirror]

    - name: L4 | All | postgres dump
      ansible.builtin.include_role:
        name: all_postgres_dump
        apply:
          tags: [l4, step_db_dump]
      when: converge_postgres_dump
      tags: [l4, step_db_dump]

    # -----------------
    # Docker steps for all OS
    # -----------------
    - name: L4 | All | docker it tools
      ansible.builtin.include_role:
        name: all_docker_it_tools
      when: converge_docker_it_tools
      tags: [l4, step_docker_it_tools]

    - name: L4 | All | docker no geeks brewing
      ansible.builtin.include_role:
        name: all_docker_no_geeks_brewing
      when: converge_docker_ngb
      tags: [l4, step_docker_ngb]

    - name: L4 | All | docker memos
      ansible.builtin.include_role:
        name: all_docker_memos
      when: converge_docker_memos
      tags: [l4, step_docker_memos]

    - name: L4 | All | docker portainer
      ansible.builtin.include_role:
        name: all_docker_portainer
      when: converge_docker_portainer
      tags: [l4, step_docker_portainer]

    - name: L4 | All | docker nginx
      ansible.builtin.include_role:
        name: all_docker_nginx
      when: converge_docker_nginx
      tags: [l4, step_docker_nginx]

    - name: L4 | All | docker vaultwarden
      ansible.builtin.include_role:
        name: all_docker_vaultwarden
      when: converge_docker_vaultwarden
      tags: [l4, step_docker_vaultwarden]

    - name: L4 | All | docker tautulli
      ansible.builtin.include_role:
        name: all_docker_tautulli
      when: converge_docker_tautulli
      tags: [l4, step_docker_tautulli]

    - name: L4 | All | docker authentik
      ansible.builtin.include_role:
        name: all_docker_authentik
      when: converge_docker_authentik
      tags: [l4, step_docker_authentik]

    - name: L4 | All | docker traefik
      ansible.builtin.include_role:
        name: all_docker_traefik
      when: converge_docker_traefik
      tags: [l4, step_docker_traefik]

    - name: L4 | All | docker plex
      ansible.builtin.include_role:
        name: all_docker_plex
      when: converge_docker_plex
      tags: [l4, step_docker_plex]

    - name: L4 | All | docker jellyfin
      ansible.builtin.include_role:
        name: all_docker_jellyfin
      when: converge_docker_jellyfin
      tags: [l4, step_docker_jellyfin]

    - name: L4 | All | docker immich
      ansible.builtin.include_role:
        name: all_docker_immich
      when: converge_docker_immich
      tags: [l4, step_docker_immich]

    - name: L4 | All | docker media acquisition
      ansible.builtin.include_role:
        name: all_docker_media_acquisition
      when: converge_docker_media_acquisition
      tags: [l4, step_docker_media_acquisition]

    - name: L4 | All | docker twingate
      ansible.builtin.include_role:
        name: all_docker_twingate
      when: converge_docker_twingate
      tags: [l4, step_docker_twingate]

    - name: L4 | All | docker cloudflare
      ansible.builtin.include_role:
        name: all_docker_cloudflare
      when: converge_docker_cloudflare
      tags: [l4, step_docker_cloudflare]

    - name: L4 | All | docker pihole
      ansible.builtin.include_role:
        name: all_docker_pihole
      when: converge_docker_pihole
      tags: [l4, step_docker_pihole, step_docker_pihole_all]

    - name: L4 | All | docker gatus
      ansible.builtin.include_role:
        name: all_docker_gatus
      when: converge_docker_gatus
      tags: [l4, step_docker_gatus, step_docker_gatus_all]

    - name: L4 | All | docker homepage
      ansible.builtin.include_role:
        name: all_docker_homepage
      when: converge_docker_homepage
      tags: [l4, step_docker_homepage, step_docker_homepage_all]

    - name: L4 | All | observability
      ansible.builtin.include_role:
        name: all_docker_observability
        apply:
          tags: [l4, step_docker_observability]
      when: converge_docker_observability
      tags: [l4, step_docker_observability]

    - name: L4 | All | docker trilium
      ansible.builtin.include_role:
        name: all_docker_trilium
        apply:
          tags: [l4, step_docker_trilium]
      when: converge_docker_trilium
      tags: [l4, step_docker_trilium]
