---
- name: Initialize hosts list
  ansible.builtin.set_fact:
    _hosts_list: []

- name: Append A-record hosts
  ansible.builtin.set_fact:
    _hosts_list: "{{ _hosts_list + [ item.address ~ ' ' ~ item.name ] }}"
  loop: "{{ pihole_a_records | default([]) }}"

- name: Initialize CNAME list
  ansible.builtin.set_fact:
    _cname_list: []

- name: Append CNAME records
  ansible.builtin.set_fact:
    _cname_list: "{{ _cname_list + [ item.alias ~ ',' ~ item.target ] }}"
  loop: "{{ pihole_cname_records | default([]) }}"

  # Show A/AAAA list
- name: Show dns.hosts JSON payload
  ansible.builtin.debug:
    msg: "{{ _hosts_list | to_json }}"

# Show CNAME list
- name: Show dns.cnameRecords JSON payload
  ansible.builtin.debug:
    msg: "{{ _cname_list | to_json }}"
  when: _cname_list | length > 0

- name: Push A/AAAA (dns.hosts)
  command: >
    docker exec {{ pihole_container_name | default('pihole') }}
    pihole-FTL --config dns.hosts '{{ _hosts_list | to_json }}'
  when: _hosts_list | length > 0
  changed_when: true

- name: Push CNAMEs (dns.cnameRecords)
  command: >
    docker exec {{ pihole_container_name | default('pihole') }}
    pihole-FTL --config dns.cnameRecords '{{ _cname_list | to_json }}'
  when: _cname_list | length > 0
  changed_when: true
