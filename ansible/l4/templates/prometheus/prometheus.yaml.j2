global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

scrape_configs:
  - job_name: gatus
    scheme: http
    static_configs:
        - targets:
          - "{{ hostvars['flagg'].ansible_host }}:8080"
  - job_name: node-exporter
    static_configs:
{% for h in groups['all'] | sort %}
{% set ports = hostvars[h].prometheus_targets | default([]) %}
{% if ports | length > 0 %}
{% set ip = hostvars[h].ansible_host | default(h) %}
      - targets:
{% for p in ports %}
          - "{{ ip }}:{{ p }}"
{% endfor %}
{% endif %}
{% endfor %}

    relabel_configs:
{% for h in groups['all'] | sort %}
{% set ports = hostvars[h].prometheus_targets | default([]) %}
{% if ports | length > 0 %}
{% set ip = hostvars[h].ansible_host | default(h) %}
      - action: replace
        source_labels: ['__address__']
        regex: '^{{ ip | regex_escape }}:.*$'
        target_label: instance
        replacement: '{{ h }}'
{% endif %}
{% endfor %}
