http:
{% if traefik_services is defined %}
  routers:
{% for service in traefik_services %}
    router-{{ service.name }}-https:
      entryPoints:
        - websecure
      service: service-{{ service.name }}
      rule: Host(`{{ service.host }}`)
{% if service.authentik | default(false) %}
      middlewares:
        - authentik
{% endif %}
      tls:
        certresolver: myresolver
{% endfor %}

  services:
{% for service in traefik_services %}
    service-{{ service.name }}:
      loadBalancer:
        servers:
          - url: "{{ service.url }}"
        passHostHeader: true
{% endfor %}
{% endif %}

  middlewares:
    authentik:
      forwardauth:
        # IMPORTANT:
        # Use Authentik directly (internal/LAN) for the forwardAuth subrequest to avoid
        # loops / hairpinning through Traefik.
        #
        # Browser redirects for login still go to https://authn.allanshomelab.com (your FQDN).
        address: "http://192.168.86.205:9180/outpost.goauthentik.io/auth/traefik"
        trustForwardHeader: true
        # authRequestHeaders:
        #   - X-Forwarded-Host
        #   - X-Forwarded-Proto
        #   - X-Forwarded-Uri
        #   - X-Forwarded-For
        #   - X-Forwarded-Port
        authResponseHeaders: X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version,authorization
