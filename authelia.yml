---
- name: Setup Authelia and Redis
  hosts: authelia_nodes
  become: yes
  gather_facts: false

  vars:
    redis_volume: "{{ docker_volumes_directory }}/redis"
    authelia_volume: "{{ docker_volumes_directory }}/authelia"

  roles:
    - role: util_getent

  tasks:  
    - name: Create volumes
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner | default(docker_volumes_owner) }}"
        group: "{{ item.group | default(docker_volumes_group) }}"
      with_items: 
        - path: "{{ redis_volume }}"
        - path: "{{ authelia_volume }}"

    - name: Setup Redis
      community.docker.docker_container:
        container_default_behavior: no_defaults
        detach: yes
        name: "redis"
        image: "redis:alpine"
        state: "started"
        recreate: "yes"
        pull: "yes"
        restart_policy: "unless-stopped"
        published_ports: 
          - "{{ redis_port }}:6379/tcp"
        volumes: 
          - "{{ redis_volume }}:/data"
        env: 
          TZ: America/New_York 

    - name: Write Authelia config files
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}" 
        owner: "{{ docker_volumes_owner }}"
        group: "{{ docker_volumes_owner }}"
        mode: 0644
      with_items:
        - src: users_database.yml.j2
          dest: "{{ authelia_volume }}/users_database.yml"
        - src: configuration.yml.j2
          dest: "{{ authelia_volume }}/configuration.yml"

    - name: Write NPM advanced configurations
      ansible.builtin.template:
        src: npm_advanced.j2
        dest: "{{ item.dest }}"
        owner: "{{ docker_volumes_owner }}"
        group: "{{ docker_volumes_owner }}"
        mode: 0644
      with_items:
        - proxy_service: speedtest
          dest: "{{ authelia_volume }}/npm_advanced_speedtest"
          downstream_host: "{{ speedtest_host }}"
          downstream_port: "{{ speedtest_port }}"
        - proxy_service: homepage
          dest: "{{ authelia_volume }}/npm_advanced_homepage"
          downstream_host: "{{ homepage_host }}"
          downstream_port: "{{ homepage_port }}"
        - proxy_service: wyl
          dest: "{{ authelia_volume }}/npm_advanced_wyl"
          downstream_host: "{{ wyl_host }}"
          downstream_port: "{{ wyl_port }}"

    - name: Setup Authelia
      community.docker.docker_container:
        container_default_behavior: no_defaults
        detach: yes
        name: "authelia"
        image: "authelia/authelia"
        state: "started"
        recreate: "yes"
        pull: "yes"
        restart_policy: "unless-stopped"
        published_ports:
          - "{{ authelia_port }}:9091/tcp"
        volumes:
          - "{{ authelia_volume }}:/config"
        env:
          TZ: America/New_York        

    - name: Fix permissions
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        recurse: yes
        owner: "{{ item.owner | default(docker_volumes_owner) }}"
        group: "{{ item.group | default(docker_volumes_group) }}"
      with_items: 
        - path: "{{ redis_volume }}"
        - path: "{{ authelia_volume }}"