## AHL
---
- name: Configure remote backup job(s).
  hosts: backup_nodes
  become: yes
  gather_facts: false 
  
  tasks:
    - name: Add remote keys to known hosts.
      ansible.builtin.known_hosts:
        name: "{{ item.host }}"
        key: "{{ lookup('pipe', 'ssh-keyscan {{ item.host }}') }}"
      with_items: "{{ remote_hosts }}"

    - name: Create a directory for log files.
      ansible.builtin.file:
        path: /var/log/ahl_backup
        state: directory

    - name: Identify old log files that can be deleted.
      find:
        paths: /var/log/ahl_backup
        age: 7d
        recurse: yes
      register: oldStuff

    - name: Delete old log files.
      file:
        path: "{{ item.path }}" 
        state: absent
      with_items: "{{ oldStuff.files }}"
      no_log: true

    - name: Create a directory for the backup scripts.
      ansible.builtin.file:
        path: /etc/ahl_backup
        state: directory

    - name: Create backup scripts.
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: 0755
      with_items:
        - src: "backup_wrapper.j2"
          dest: "/etc/ahl_backup/backupWrapper.sh"
        - src: "backup_script.j2"
          dest: "/etc/ahl_backup/backup.sh"

    - name: Schedule backup CRON job.
      ansible.builtin.cron:
        name: ahl_backup
        minute: "{{ backup_minute }}"
        hour: "{{ backup_hour }}"
        job: "/bin/sh /etc/ahl_backup/backupWrapper.sh"
