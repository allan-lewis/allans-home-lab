---
- name: Setup Grafana
  hosts: grafana_nodes
  become: yes
  gather_facts: false

  vars:
    grafana_data_volume: "{{ docker_volumes_directory }}/grafana"

  roles:
    - role: ../roles/util_getent
    - role: ../roles/util_directory
      vars:
        util_dirs: 
          - path: "{{ grafana_data_volume }}"

  tasks:
    - name: Setup Grafana
      community.docker.docker_container:
        container_default_behavior: no_defaults
        detach: yes
        name: "grafana"
        image: "grafana/grafana"
        state: "started"
        recreate: "yes"
        pull: "yes"
        restart_policy: "unless-stopped"
        published_ports: 
          - "{{ grafana_port }}:3000/tcp"
        volumes: 
          - "{{ grafana_data_volume }}:/var/lib/grafana"
        user: "{{ control_uid }}:{{ control_gid }}"
