---
- hosts: docker_nodes
  become: yes
  gather_facts: false

  tasks:

    - name: Recording passwd information 
      ansible.builtin.getent:
        database: passwd

    - name: Setting user and group facts
      ansible.builtin.set_fact:
        control_uid: "{{ ansible_facts.getent_passwd[control_user].1 | int }}"
        control_gid: "{{ ansible_facts.getent_passwd[control_user].2 | int }}"

    - name: Setting up Docker container(s)
      ansible.builtin.include_role:
        name: container
      vars:
        container: "{{ item }}"
      with_items: 
        - "{{ portainer_container }}"
        - "{{ syncthing_container }}"

- hosts: pihole_nodes
  become: yes
  gather_facts: false

  tasks:

    - name: Disabling the default DNS service
      ansible.builtin.service:
        name: systemd-resolved
        state: stopped
        enabled: no

    - name: Ensuring that resolv.conf has the correct contents
      ansible.builtin.template:
        src: resolv.conf.j2
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: 0644

    - name: Setting up Docker container(s)
      ansible.builtin.include_role:
        name: container
      vars:
        container: "{{ item }}"
      with_items:
        - "{{ pihole_container }}"

- hosts: mariadb_nodes
  become: yes
  gather_facts: false

  tasks:

    - name: Setting up Docker container(s)
      ansible.builtin.include_role:
        name: container
      vars:
        container: "{{ item }}"
      with_items:
        - "{{ mariadb_container }}"

- hosts: guacamole_nodes
  become: yes
  gather_facts: false

  tasks:

    - name: Setting up Docker container(s)
      ansible.builtin.include_role:
        name: container
      vars:
        container: "{{ item }}"
      with_items:
        - "{{ guacd_container }}"
        - "{{ guacamole_container }}"

- hosts: npm_nodes
  become: yes
  gather_facts: false

  tasks:

    - name: Setting up Docker container(s)
      ansible.builtin.include_role:
        name: container
      vars:
        container: "{{ item }}"
      with_items:
        - "{{ npm_container }}"

- hosts: kuma_nodes
  become: yes
  gather_facts: false

  tasks:

    - name: Setting up Docker container(s)
      ansible.builtin.include_role:
        name: container
      vars:
        container: "{{ item }}"
      with_items:
        - "{{ kuma_container }}"
