---
- import_role:
    name: docker_getent

- name: Create Docker volume(s)
  ansible.builtin.file:
    path: "{{ wireguard_config_volume }}"
    state: directory
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"

- name: Deploy Wireguard container
  community.docker.docker_container:
    container_default_behavior: no_defaults
    detach: yes
    name: "wireguard"
    image: "lscr.io/linuxserver/wireguard:latest"
    state: "started"
    recreate: "yes"
    pull: "yes"
    restart_policy: "unless-stopped"
    published_ports: 
      - "{{ wireguard_udp_port }}:51820/udp"
    volumes: 
      - "{{ wireguard_config_volume }}:/config"
      - /lib/modules:/lib/modules
    env: 
      TZ: America/New_York
      PUID: "{{ ahl_user_uid }}"
      PGID: "{{ ahl_user_gid }}"
      PEERS: "{{ wireguard_peers }}"
      SERVERURL: "{{ wireguard_url }}"
      SERVERPORT: "{{ wireguard_udp_port | int }}"
    sysctls:
      net.ipv4.conf.all.src_valid_mark: 1
    capabilities:
      - NET_ADMIN
      - SYS_MODULE

# - name: Create WG Eeay volume
#   ansible.builtin.file:
#     path: "{{ wgeasy_config_volume }}"
#     state: directory
#     owner: "{{ ansible_ssh_user }}"
#     group: "{{ ansible_ssh_user }}"

# - name: Deploy WG Easy container
#   community.docker.docker_container:
#     container_default_behavior: no_defaults
#     detach: yes
#     name: "wg-easy"
#     image: "weejewel/wg-easy"
#     state: "started"
#     recreate: "yes"
#     pull: "yes"
#     restart_policy: "unless-stopped"
#     published_ports: 
#       - "{{ wireguard_http_port }}:51821/tcp"
#       - "{{ wireguard_udp_port }}:51820/udp"
#     volumes: 
#       - "{{ wgeasy_config_volume }}:/etc/wireguard"
#     env: 
#       WG_HOST: "{{ wireguard_url }}"
#       PASSWORD: "{{ wireguard_password }}"
#       WG_DEFAULT_ADDRESS: "{{ wireguard_default_address }}"
#       WG_DEFAULT_DNS: "{{ wireguard_default_dns }}"
#       WG_POST_UP: "iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth+ -j MASQUERADE"
#       WG_POST_DOWN: "iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth+ -j MASQUERADE"
#     sysctls:
#       net.ipv4.conf.all.src_valid_mark: 1
#       net.ipv4.ip_forward: 1
#     capabilities:
#       - NET_ADMIN
#       - SYS_MODULE