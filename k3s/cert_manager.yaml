## AHL
---
- name: Install cert-manager.
  hosts: k3s_cert_manager
  become: yes
  gather_facts: false
  environment:
    K8S_AUTH_KUBECONFIG: "{{ kubeconfig_path }}"
    KUBECONFIG: "{{ kubeconfig_path }}"

  roles:
    - role: cert_manager

- name: Wait for cert-manager certificates to be ready.
  hosts: k3s_cert_manager
  become: yes
  gather_facts: no
  environment:
    K8S_AUTH_KUBECONFIG: "{{ kubeconfig_path }}"
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    - ansible.builtin.shell: kubectl -n default wait --for=condition=Ready certificate {{ item.certificate_name }} --timeout=10s
      register: cert_ready
      until: cert_ready.rc == 0
      retries: 60
      delay: 30
      with_items: "{{ cert_manager_certificates }}"