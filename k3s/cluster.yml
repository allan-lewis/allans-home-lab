---
- hosts: k3s_nodes
  gather_facts: yes
  become: yes
  roles:
    - role: cluster_prereq
    - role: cluster_download
    - role: cluster_raspberrypi

- hosts: k3s_master
  become: yes
  roles:
    - role: cluster_master

- hosts: k3s_node
  become: yes
  roles:
    - role: cluster_node

- hosts: k3s_master
  become: yes
  roles:
    - role: cluster_post

- hosts: localhost
  become: no
  tasks:
    - name: Create a local directoty for kube config
      ansible.builtin.file:
        path: ~/.kube
        state: directory

- hosts: k3s_master[0]
  become: yes
  tasks:
    - name: Fetch remote cube config
      ansible.builtin.fetch:
        src: /root/.kube/config
        dest: ~/.kube/
        flat: yes

- hosts: k3s_master[0]
  become: yes
  tasks:
    - name: Proactively create namespace(s)
      kubernetes.core.k8s:
        state: present
        template: namespace.yml.j2
      vars:
        namespace_name: "{{ item.namespace_name }}"
      with_items: "{{ k3s_namespaces }}"
