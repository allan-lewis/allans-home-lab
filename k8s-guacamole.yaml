## AHL
---
- name: Install Guacamole and guacd.
  hosts: homelab_k8s_guacamole_nodes
  become: no
  gather_facts: no
  environment:
    K8S_AUTH_KUBECONFIG: "{{ homelab_k8s_kubeconfig_path }}"
  vars:
    homelab_k8s_namespace: "{{ homelab_k8s_guacamole_namespace | default('guacamole') }}"
    homelab_k8s_guacamole_guacd_port: "{{ homelab_k8s_guacd_service_port | default(35101) }}"

  roles:
    # GUACAMOLE
    - role: k8s_generic_service
      vars:
        homelab_k8s_service_name: "{{ homelab_k8s_guacamole_service_name | default('guacamole') }}"
        homelab_k8s_service_port: "{{ homelab_k8s_guacamole_service_port | default(35100) }}"
        homelab_k8s_service_target_port: "{{ homelab_k8s_guacamole_service_target_port | default(8080) }}"
        homelab_k8s_container_name: "{{ homelab_k8s_guacamole_container_name | default('guacamole') }}"
        homelab_k8s_container_image: "{{ homelab_k8s_guacamole_container_image | default('guacamole/guacamole:' + homelab_versions.k8s_guacamole) }}"
        homelab_k8s_traefik_routes:
          - host: "{{ homelab_k8s_guacamole_host }}"
        homelab_k8s_environment_vars:
          - name: GUACD_HOSTNAME
            value: "{{ homelab_k8s_guacamole_guacd_host }}"
          - name: GUACD_PORT
            value: "\"{{ homelab_k8s_guacamole_guacd_port }}\""
          - name: MYSQL_HOSTNAME
            value: "{{ homelab_k8s_guacamole_mysql_host }}"
          - name: MYSQL_DATABASE
            value: "{{ homelab_k8s_guacamole_mysql_db }}"
          - name: MYSQL_USER
            value: "{{ homelab_k8s_guacamole_mysql_user }}"
          - name: MYSQL_PASSWORD
            value: "{{ homelab_k8s_guacamole_mysql_password }}"
          - name: OPENID_AUTHORIZATION_ENDPOINT
            value: "{{ homelab_k8s_guacamole_openid_authorization_endpoint }}"
          - name: OPENID_CLIENT_ID
            value: "{{ homelab_k8s_guacamole_openid_client_id }}"
          - name: OPENID_ISSUER
            value: "{{ homelab_k8s_guacamole_openid_issuer }}"
          - name: OPENID_JWKS_ENDPOINT
            value: "{{ homelab_k8s_guacamole_openid_jwks_endpoint }}"
          - name: OPENID_REDIRECT_URI
            value: "{{ homelab_k8s_guacamole_openid_redirect_uri }}"
          - name: OPENID_USERNAME_CLAIM_TYPE
            value: preferred_username
    # GUACD
    - role: k8s_generic_service
      vars:
        homelab_k8s_service_load_balancer_ip: "{{ homelab_k8s_guacd_load_balancer_ip }}"
        homelab_k8s_service_name: "{{ homelab_k8s_guacd_service_name | default('guacd') }}"
        homelab_k8s_service_port: "{{ homelab_k8s_guacamole_guacd_port }}"
        homelab_k8s_service_target_port: "{{ homelab_k8s_guacd_service_target_port | default(4822) }}"
        homelab_k8s_service_template: "homelab-k8s-service-load-balancer.yaml.j2"
        homelab_k8s_container_name: "{{ homelab_k8s_guacd_container_name | default('guacd') }}"
        homelab_k8s_container_image: "{{ homelab_k8s_guacd_container_image | default('guacamole/guacd:' + homelab_versions.k8s_guacd) }}"
