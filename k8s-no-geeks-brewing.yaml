## AHL
---
- name: Install No Geeks Brewing services.
  hosts: homelab_talos_management_nodes[0]
  become: no
  gather_facts: no
  environment:
    K8S_AUTH_KUBECONFIG: "{{ homelab_k8s_kubeconfig_path }}"
  vars:
    homelab_k8s_namespace: "{{ homelab_k8s_no_geeks_brewing_namespace | default('no-geeks-brewing') }}"
    
  roles:
    # NO GEEKS BREWING WEB SITE
    - role: k8s_generic_service
      vars:
        homelab_k8s_service_name: "{{ homelab_k8s_no_geeks_brewing_site_service_name | default('no-geeks-brewing-web-server') }}"
        homelab_k8s_service_port: "{{ homelab_k8s_no_geeks_brewing_site_service_port | default(3000) }}"
        homelab_k8s_container_name: "{{ homelab_k8s_no_geeks_brewing_site_container_name | default('no-geeks-brewing-site') }}"
        homelab_k8s_container_image: "{{ homelab_k8s_no_geeks_brewing_site_container_image | default('allanelewis/ngb-nextjs:' + homelab_versions.k8s_no_geeks_brewing_site) }}"
        homelab_k8s_environment_vars:
          - name: AUTH_SECRET
            value: "{{ homelab_k8s_no_geeks_brewing_auth_secret }}"
          - name: AUTH_AUTHENTIK_ID
            value: "{{ homelab_k8s_no_geeks_brewing_auth_authentik_id }}"
          - name: AUTH_AUTHENTIK_SECRET
            value: "{{ homelab_k8s_no_geeks_brewing_auth_authentik_secret }}"
          - name: AUTH_AUTHENTIK_ISSUER
            value: "{{ homelab_k8s_no_geeks_brewing_auth_authentik_issuer }}"
          - name: AUTH_TRUST_HOST
            value: "'true'"
          - name: AUTH_URL
            value: "{{ homelab_k8s_no_geeks_brewing_auth_url }}"
          - name: GRAPHQL_URL
            value: "{{ homelab_k8s_no_geeks_brewing_graphql_url }}"
        homelab_k8s_traefik_routes: "{{ homelab_k8s_no_geeks_brewing_site_routes }}"
    # NO GEEKS BREWING API
    - role: k8s_generic_service
      vars:
        homelab_k8s_service_name: "{{ homelab_k8s_no_geeks_brewing_api_service_name | default('no-geeks-brewing-api-server') }}"
        homelab_k8s_service_port: "{{ homelab_k8s_no_geeks_brewing_api_service_port | default(8080) }}"
        homelab_k8s_container_name: "{{ homelab_k8s_no_geeks_brewing_api_container_name | default('no-geeks-brewing-api') }}"
        homelab_k8s_container_image: "{{ homelab_k8s_no_geeks_brewing_api_container_image | default('allanelewis/ngb-graphql:' + homelab_versions.k8s_no_geeks_brewing_api) }}"
        homelab_k8s_environment_vars:
          - name: NOGEEKSBREWING_BREWFATHER_AUTHTOKEN
            value: "{{ homelab_k8s_no_geeks_brewing_api_auth_token }}"
        homelab_k8s_traefik_routes: "{{ homelab_k8s_no_geeks_brewing_api_routes }}"
