---
- hosts: pihole_nodes
  become: yes
  gather_facts: false

  vars:
    pihole_data_volume: "{{ docker_volumes_directory }}/pihole/data"
    pihole_dns_volume: "{{ docker_volumes_directory }}/pihole/dns"

  roles:
    - role: util_directory
      vars:
        util_dirs: 
          - path: "{{ pihole_data_volume }}"
          - path: "{{ pihole_dns_volume }}"

  tasks:

    - name: Disabling the default DNS service
      ansible.builtin.service:
        name: systemd-resolved
        state: stopped
        enabled: no

    - name: Ensuring that resolv.conf has the correct contents
      ansible.builtin.template:
        src: resolv.conf.j2
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: 0644
        
    - name: Setup Pi-hole
      community.docker.docker_container:
        container_default_behavior: no_defaults
        detach: yes
        name: "pihole"
        image: "pihole/pihole"
        state: "started"
        recreate: "yes"
        pull: "yes"
        restart_policy: "unless-stopped"
        published_ports: 
          - "53:53/tcp"
          - "53:53/udp"
          - "67:67/udp"
          - "{{ pihole_http_port }}:80/tcp"
        volumes: 
          - "{{ pihole_data_volume }}:/etc/pihole"
          - "{{ pihole_dns_volume }}:/etc/dnsmasq.d"
        env: 
          TZ: 'America/New_York'
          WEBPASSWORD: "{{ pihole_admin_password }}"
        capabilities:
          - NET_ADMIN
