---
- hosts: plex_nodes
  become: yes
  gather_facts: false

  vars:
    tautulli_config: "{{ docker_volumes_directory }}/tautulli"
    mounts:
      - path: /television
        src: "{{ nas_host }}:/volume1/nfs-television"
      - path: /movies
        src: "{{ nas_host }}:/volume1/nfs-movies"

  tasks:
    - name: Create mount points
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ control_user }}"
        group: "{{ control_user }}"
      with_items: "{{ mounts }}"

    - name: Mount the NFS volumes
      ansible.posix.mount:
        path: "{{ item.path }}"
        src: "{{ item.src }}"
        fstype: nfs
        opts: resvport,rw
        state: mounted
      with_items: "{{ mounts }}"

    - name: Setting up Docker container(s)
      ansible.builtin.include_role:
        name: passwd

    - name: Create config volume
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner | default(docker_volumes_owner) }}"
        group: "{{ item.group | default(docker_volumes_group) }}"
      with_items: 
        - path: "{{ docker_volumes_directory }}/plex"
        - path: "{{ tautulli_config }}"

    - name: Setup Plex
      community.docker.docker_container:
        container_default_behavior: no_defaults
        detach: yes
        name: "plex"
        image: "lscr.io/linuxserver/plex:latest"
        state: "started"
        recreate: "yes"
        pull: "yes"
        restart_policy: "unless-stopped"
        published_ports: 
          - "{{ plex_port }}:32400"
          - 1900:1900/udp
          - 3005:3005
          - 5353:5353/udp
          - 8324:8324
          - 32410:32410/udp
          - 32412:32412/udp
          - 32413:32413/udp
          - 32414:32414/udp
          - 32469:32469
        volumes: 
          - "{{ docker_volumes_directory }}/plex:/config"
          - /television:/shows
          - /movies:/movies
        env: 
          TZ: America/New_York
          VERSION: docker
          # PLEX_CLAIM: "{{ plex_claim }}"
          PUID: "{{ control_uid }}"
          PGID: "{{ control_gid }}"

    - name: Setup Tautulli
      community.docker.docker_container:
        container_default_behavior: no_defaults
        detach: yes
        name: "tautulli"
        image: "lscr.io/linuxserver/tautulli:latest"
        state: "started"
        recreate: "yes"
        pull: "yes"
        restart_policy: "unless-stopped"
        published_ports: 
          - "{{ tautulli_port }}:8181"
        volumes: 
          - "{{ tautulli_config }}:/config"
        env: 
          TZ: America/New_York
          PUID: "{{ control_uid }}"
          PGID: "{{ control_gid }}"