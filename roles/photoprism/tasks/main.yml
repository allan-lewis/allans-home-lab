---
- import_role:
    name: ahl_getent

- import_role: 
    name: ahl_mount      
  vars: 
      mount_items: 
        - path: "{{ photoprism_volume }}"
          src: "{{ nfs_share_photoprism }}"
          owner: "{{ ansible_ssh_user }}" 
          group: "{{ ansible_ssh_user }}" 
          access: "rw"

- import_role:
    name: ahl_mkdir
  vars:
    dir_items:
      - path: "{{ photoprism_storage_volume }}"
      - path: "{{ photoprism_originals_volume }}"
      - path: "{{ photoprism_import_volume }}"

- name: Run PhotoPrism Docker container
  docker_container:
    name: photoprism
    image: photoprism/photoprism
    state: started
    recreate: yes
    pull: yes
    restart_policy: unless-stopped
    security_opts:
      - "apparmor:unconfined"
      - "seccomp:unconfined"
    published_ports:
      - "{{ photoprism_http_port }}:2342/tcp"
    volumes:
      - "{{ photoprism_storage_volume }}:/photoprism/storage"
      - "{{ photoprism_originals_volume }}:/photoprism/originals"
      - "{{ photoprism_import_volume }}:/photoprism/import"
    env:
      PHOTOPRISM_UPLOAD_NSFW: "true"
      PHOTOPRISM_ADMIN_PASSWORD: "{{ photoprism_admin_password }}"
    user: "{{ ahl_user_uid }}:{{ ahl_user_uid }}"
