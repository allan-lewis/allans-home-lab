- name: Ensure that the default DNS service is disabled
  ansible.builtin.service:
    name: systemd-resolved
    state: stopped
    enabled: no

- name: Ensure that resolv.conf has the correct contents
  ansible.builtin.template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: 0644

- name: Ensure that Docker container(s) are up and running
  ansible.builtin.include_role:
    name: container
  vars:
    container: "{{ item }}"
    pihole_data_volume: "{{ docker_volumes_directory }}/pihole/data"
    pihole_dns_volume: "{{ docker_volumes_directory }}/pihole/dns"
  with_items: 
    - name: "pihole"
      pretty_name: "Pi-hole"
      image: "pihole/pihole"
      paths:
        - path: "{{ pihole_data_volume }}"
        - path: "{{ pihole_dns_volume }}"
      ports:
        - "53:53/tcp"
        - "53:53/udp"
        - "67:67/udp"
        - "{{ pihole_http_port }}:80/tcp"
      volumes:
        - "{{ pihole_data_volume }}:/etc/pihole"
        - "{{ pihole_dns_volume }}:/etc/dnsmasq.d"
      capabilities:
        - NET_ADMIN
      environment:
        TZ: 'America/New_York'
        WEBPASSWORD: "{{ pihole_admin_password }}"
