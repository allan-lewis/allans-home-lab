---
- name: Run Portainer Agent Docker container
  community.docker.docker_container:
    container_default_behavior: no_defaults
    detach: yes
    name: "portainer_agent"
    image: "portainer/agent"
    state: "started"
    recreate: "yes"
    pull: "yes"
    restart_policy: "unless-stopped"
    published_ports: 
      - "{{ portainer_agent_port }}:9001/tcp"
    volumes: 
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes

- name: Run Docker Socket Proxy Docker container
  community.docker.docker_container:
    container_default_behavior: no_defaults
    detach: yes
    name: "docker_proxy"
    image: "ghcr.io/tecnativa/docker-socket-proxy:latest"
    state: "started"
    recreate: "yes"
    pull: "yes"
    restart_policy: "unless-stopped"
    published_ports: 
      - "{{ docker_proxy_port }}:2375/tcp"
    volumes: 
      - /var/run/docker.sock:/var/run/docker.sock:ro 
    env:
      CONTAINERS: "1 | int"
      POST: "0 | int" 
  