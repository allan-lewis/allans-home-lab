## AHL
---
- name: Create a namespace for Guacamole and guacd.
  kubernetes.core.k8s:
    state: present
    template: namespace.yml.j2

- name: Create the k8s Guacamole deployment.
  kubernetes.core.k8s:
    state: "{{ homelab_kubernetes_state }}"
    template: deployment.yml.j2
  vars:
    homelab_kubernetes_service_name: "{{ homelab_talos_guacamole_service_name }}"
    homelab_kubernetes_container_name: "{{ homelab_talos_guacamole_service_name }}"
    homelab_kubernetes_container_image: "guacamole/guacamole:{{ homelab_versions.talos_guacamole }}"
    homelab_kubernetes_service_replicas: 1
    homelab_kubernetes_environment_vars:
      - name: GUACD_HOSTNAME
        value: "{{ homelab_talos_guacamole_guacd_host }}"
      - name: GUACD_PORT
        value: "{{ homelab_talos_guacd_service_port }}"
      - name: MYSQL_HOSTNAME
        value: "{{ homelab_talos_guacamole_mysql_host }}"
      - name: MYSQL_DATABASE
        value: "{{ homelab_talos_guacamole_mysql_db }}"
      - name: MYSQL_USER
        value: "{{ homelab_talos_guacamole_mysql_user }}"
      - name: MYSQL_PASSWORD
        value: "{{ homelab_talos_guacamole_mysql_password }}"

- name: Create the k8s Guacamole service.
  kubernetes.core.k8s:
    state: "{{ homelab_kubernetes_state }}"
    template: service.yml.j2
  vars:    
    homelab_kubernetes_service_name: "{{ homelab_talos_guacamole_service_name }}"
    homelab_kubernetes_service_port: "{{ homelab_talos_guacamole_service_port }}"
    homelab_kubernetes_service_target_port: "{{ homelab_talos_guacamole_service_target_port }}"

- name: Create Traefik ingresses for Guacamole.
  kubernetes.core.k8s:
    state: "{{ homelab_kubernetes_state }}"
    template: traefik_ingress_route.yml.j2
  vars:
    homelab_kubernetes_service_name: "{{ homelab_talos_guacamole_service_name }}"
    homelab_kubernetes_service_port: "{{ homelab_talos_guacamole_service_port }}"
    homelab_talos_traefik_routes:
      - host: "{{ homelab_talos_guacamole_host }}"

- name: Create the k8s gucd deployment.
  kubernetes.core.k8s:
    state: "{{ homelab_kubernetes_state }}"
    template: deployment.yml.j2
  vars:
    homelab_kubernetes_service_name: "{{ homelab_talos_guacd_service_name }}"
    homelab_kubernetes_container_name: "{{ homelab_talos_guacd_service_name }}"
    homelab_kubernetes_container_image: "guacamole/guacd:{{ homelab_versions.talos_guacd }}"
    homelab_kubernetes_service_replicas: 1

- name: Create the k8s guacd service.
  kubernetes.core.k8s:
    state: "{{ homelab_kubernetes_state }}"
    template: load_balancer_service.yml.j2
  vars:
    homelab_kubernetes_service_name: "{{ homelab_talos_guacd_service_name }}"
    homelab_kubernetes_service_port: "{{ homelab_talos_guacd_service_port }}"
    homelab_kubernetes_service_target_port: "{{ homelab_talos_guacd_service_target_port }}"
    homelab_kubernetes_service_load_balancer_ip: "{{ homelab_talos_guacd_load_balancer_ip }}"
