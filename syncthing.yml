---
- hosts: syncthing_nodes
  become: yes
  gather_facts: false

  roles:
    - role: util_getent
    - role: util_mount
      vars: 
        util_mounts: 
          - path: "{{ mount_syncthing }}"
            src: "{{ nfs_share_syncthing }}"
            owner: "{{ control_user }}" 
            group: "{{ control_user }}" 
            access: "rw"
      when: syncthing_mount is true
    - role: util_directory
      vars:
        util_dirs: 
          - path: "{{ docker_volumes_directory }}/syncthing"

  tasks:
    - name: Setup Syncthing
      community.docker.docker_container:
        container_default_behavior: no_defaults
        detach: yes
        name: "syncthing"
        image: "lscr.io/linuxserver/syncthing:latest"
        state: "started"
        recreate: "yes"
        pull: "yes"
        restart_policy: "unless-stopped"
        network_mode: "host"
        volumes: "{{ syncthing_volumes }}"
        env: 
          TZ: America/New_York
          PUID: "{{ control_uid }}"
          PGID: "{{ control_gid }}"
