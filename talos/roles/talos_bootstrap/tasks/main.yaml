## AHL
---
- name: Check for config file existence.
  ansible.builtin.stat:
    path: "{{ talos_config_file }}"
  register: stat_result

- name: Display the config file result.
  ansible.builtin.debug:
    var: stat_result

- name: Create a directory for host-specific patch files.
  when: "not stat_result.stat.exists"
  ansible.builtin.file:
    path: "{{ talos_patch_directory }}"
    state: directory

- name: Write a patch file for the first control node.
  when: "not stat_result.stat.exists"
  ansible.builtin.template:
    src: "control-node-patch.yaml.j2"
    dest: "{{ talos_patch_directory }}/{{ talos_ephemeral_control_node }}.yaml"
  vars:
    host: "{{ hostvars[talos_ephemeral_control_node] }}"

- name: Generate config for cluster.
  when: "not stat_result.stat.exists"
  ansible.builtin.command: talosctl gen config talos-proxmox-cluster https://{{ talos_control_plane_ip }}:6443 --output-dir {{ talos_config_directory }} --install-image factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515:{{ talos_version }}
  changed_when: true

- name: Apply config to first control plane node.
  when: "not stat_result.stat.exists"
  ansible.builtin.command: talosctl apply-config --insecure --nodes {{ talos_ephemeral_control_ip }} --file ~/.talos/controlplane.yaml --config-patch @{{ talos_patch_directory }}/{{ talos_ephemeral_control_node }}.yaml
  changed_when: true

- name: Configure first Talos endpoint.
  when: "not stat_result.stat.exists"
  ansible.builtin.command: talosctl config endpoint {{ talos_control_plane_ip }} --talosconfig {{ talos_config_file }}
  changed_when: true

- name: Configure first Talos node.
  when: "not stat_result.stat.exists"
  ansible.builtin.command: talosctl config node {{ talos_control_plane_ip }} --talosconfig {{ talos_config_file }}
  changed_when: true

- name: Bootstrap Talos cluster.
  when: "not stat_result.stat.exists"
  ansible.builtin.command:
    cmd: "talosctl bootstrap --talosconfig {{ talos_config_file }}"
  register: bootstrap_result
  retries: 10
  delay: 30
  until: bootstrap_result.rc == 0
  changed_when: bootstrap_result.rc == 0
