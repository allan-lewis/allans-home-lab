## AHL
---
- name: Write patch files for worker nodes.
  ansible.builtin.template:
    src: "worker-node-patch.yaml.j2"
    dest: "{{ talos_patch_directory }}/{{ hostvars[item].inventory_hostname }}.yaml"
  with_items: "{{ groups['talos_worker_nodes'] }}"

- name: Apply configs to worker nodes.
  ansible.builtin.command: talosctl apply-config --insecure --nodes {{ hostvars[item].ephemeral_host }} --file ~/.talos/worker.yaml --config-patch @{{ talos_patch_directory }}/{{ item }}.yaml
  changed_when: true
  with_items: "{{ groups['talos_worker_nodes'] }}"
